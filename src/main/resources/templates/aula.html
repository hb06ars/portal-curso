<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portal Cursos - Dados</title>

    <link rel="stylesheet" th:href="@{/css/style-aula.css}">
</head>

<body>

<!-- HEADER -->
<div th:insert="fragments/header :: header"></div>

<!-- MENU -->
<div th:insert="fragments/menu :: menu"></div>

<!-- CONTEÚDO -->
<div class="container">

<div class="app">
    <header>
        <div class="brand">
            <div class="logo">
                <img src="icone.png" alt="Java Logo">
            </div>
            <div>
                <h1>APRENDENDO A PROGRAMAR</h1>
                <p>Programação Básica para iniciantes.</p>
            </div>
        </div>
        <nav>
            <button id="btn-full" title="Tela cheia">⤢</button>
        </nav>
    </header>

    <aside class="sidebar">
        <h3 class="course-title">Curso: Desenvolvimento</h3>

        <div id="lessons">
            <div class="lesson" data-src="@{/aula/1}">
                <div class="meta">
                    <strong>Aula 1 - Introdução</strong>
                    <small>7:07</small>
                </div>
            </div>

            <div class="lesson" data-src="@{/secure/video/2}" data-title="Aula 2 - HTML Básico" data-desc="Estrutura HTML e tags principais">
                <div class="meta">
                    <strong>Aula 2 - HTML Básico</strong>
                    <small>12:40</small>
                </div>
            </div>

            <div class="lesson" data-src="@{/secure/video/3}" data-title="Aula 3 - CSS Básico" data-desc="Estilização e layout">
                <div class="meta">
                    <strong>Aula 3 - CSS Básico</strong>
                    <small>8:12</small>
                </div>
            </div>
        </div>

    </aside>

    <main class="player-card">
        <div class="video-wrap">
            <video id="player" controls controlsList="nodownload" oncontextmenu="return false;">
                <source id="videoSource" type="video/mp4">
                Seu navegador não suporta o elemento de vídeo.
            </video>

        </div>

        <div class="controls">
            <button id="btn-prev" title="Aula anterior">⟵</button>
            <button id="btn-play" title="Play/Pause">▶</button>
            <button id="btn-next" title="Próxima aula">⟶</button>

            <div class="progress" id="progress"><div id="progress-bar"></div></div>

            <select id="speed" title="Velocidade">
                <option value="0.5">0.5x</option>
                <option value="0.75">0.75x</option>
                <option value="1" selected>1x</option>
                <option value="1.25">1.25x</option>
                <option value="1.5">1.5x</option>
                <option value="2">2x</option>
            </select>
        </div>

        <div class="info">
            <h2 id="title">-</h2>
            <p id="desc">-</p>
        </div>
    </main>
</div>

</div>
<!-- CONTEÚDO -->

<!-- SCRIPTS -->
<div th:replace="fragments/scripts :: scripts"></div>
<script>
fetch("/aula/1")
  .then(r => r.text())
  .then(url => {
     const source = document.getElementById("videoSource");
     source.src = url;
     document.getElementById("player").load();
  });




    const lessonsEl = document.getElementById('lessons')
    const player = document.getElementById('player')
    const progressBar = document.getElementById('progress-bar')
    const btnPlay = document.getElementById('btn-play')
    const btnNext = document.getElementById('btn-next')
    const btnPrev = document.getElementById('btn-prev')
    const speed = document.getElementById('speed')
    const titleEl = document.getElementById('title')
    const descEl = document.getElementById('desc')
    const btnFull = document.getElementById('btn-full')

    let lessons = Array.from(document.querySelectorAll('.lesson'))
    let currentIndex = 0

    const saved = JSON.parse(localStorage.getItem('udemyLiteState') || 'null')
    if (saved && typeof saved.index === 'number') currentIndex = saved.index

    function setActiveLesson(idx){
      lessons.forEach(l => l.classList.remove('active'))
      const sel = lessons[idx]
      if(!sel) return
      sel.classList.add('active')
      const src = sel.getAttribute('data-src')
      const t = sel.getAttribute('data-title')
      const d = sel.getAttribute('data-desc')
      if(player.querySelector('source')){
        player.querySelector('source').src = src
        player.load()
      } else player.src = src

      titleEl.textContent = t
      descEl.textContent = d
      currentIndex = idx
      saveState()
    }

    lessons.forEach((l, i) => {
      l.addEventListener('click', () => setActiveLesson(i))
    })

    function restorePosition(){
      const st = JSON.parse(localStorage.getItem('udemyLiteState') || 'null')
      if(!st) return
      if(st.index !== undefined) setActiveLesson(st.index)
      if(st.time) {
        player.addEventListener('loadedmetadata', () => {
          if(player.duration > st.time) player.currentTime = st.time
        }, {once:true})
      }
    }

    btnPlay.addEventListener('click', () => {
      if(player.paused) player.play()
      else player.pause()
      updatePlayButton()
    })

    function updatePlayButton(){
      btnPlay.textContent = player.paused ? '▶' : '❚❚'
    }

    player.addEventListener('play', updatePlayButton)
    player.addEventListener('pause', updatePlayButton)

    btnNext.addEventListener('click', () => {
      if(currentIndex < lessons.length -1) setActiveLesson(currentIndex+1)
    })
    btnPrev.addEventListener('click', () => {
      if(currentIndex > 0) setActiveLesson(currentIndex-1)
    })

    player.addEventListener('timeupdate', () => {
      if(player.duration) {
        const pct = (player.currentTime / player.duration) * 100
        progressBar.style.width = pct + '%'
        saveState()
      }
    })

    document.getElementById('progress').addEventListener('click', (e) => {
      const rect = e.currentTarget.getBoundingClientRect()
      const x = e.clientX - rect.left
      const pct = x / rect.width
      if(player.duration) player.currentTime = pct * player.duration
    })

    speed.addEventListener('change', () => {
      player.playbackRate = parseFloat(speed.value)
    })

    function saveState(){
      const st = { index: currentIndex, time: Math.floor(player.currentTime || 0) }
      localStorage.setItem('udemyLiteState', JSON.stringify(st))
    }

    player.addEventListener('ended', () => {
      if(currentIndex < lessons.length -1) setActiveLesson(currentIndex+1)
    })

    document.addEventListener('keydown', (e) => {
      if(e.code === 'Space') { e.preventDefault(); if(player.paused) player.play(); else player.pause(); }
      if(e.code === 'ArrowRight') player.currentTime = Math.min(player.duration || 0, player.currentTime + 10)
      if(e.code === 'ArrowLeft') player.currentTime = Math.max(0, player.currentTime - 10)
    })

    btnFull.addEventListener('click', () => {
      const el = document.documentElement
      if(!document.fullscreenElement) {
        el.requestFullscreen?.()
      } else document.exitFullscreen?.()
    })

    player.playbackRate = parseFloat(speed.value)
    setTimeout(restorePosition, 50)

    if(!JSON.parse(localStorage.getItem('udemyLiteState') || 'null')) setActiveLesson(currentIndex)

    player.addEventListener('error', (ev) => {
      console.error('Erro ao reproduzir vídeo', ev)
    })
</script>

</body>
</html>
